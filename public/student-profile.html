<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CareSim Student Portal</title>
    <link rel="icon" type="image/png" sizes="32x32" href="asat.png">
    <link rel="icon" type="image/png" sizes="16x16" href="asat.png">
    <link rel="shortcut icon" type="image/png" href="asat.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="student-portal.css">
</head>
<body class="student-portal">
    <!-- Header / Navigation -->
    <header class="portal-header">
        <div class="header-content">
            <div class="logo">
                <a class="logo-link" href="/student-dashboard">
                    <img src="caresimm.png" alt="CareSim" class="header-logo">
                </a>
            </div>
            <div class="header-right">
                <nav class="nav-tabs">
                    <a href="/student-dashboard" class="nav-tab">Dashboard</a>
                    <a href="/student-lessons" class="nav-tab">Lessons</a>
                    <a href="/student-progress" class="nav-tab">Progress</a>
                    <a href="/student-class" class="nav-tab">Class</a>
                    <a href="/student-certificates" class="nav-tab">Certificates</a>
                    <a href="/student-profile" class="nav-tab active">Profile</a>
                </nav>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>
    <div class="portal-container profile-page">
        <div class="profile-page-wrapper">
            <section class="profile-layout-grid">
                <form id="profileForm" class="profile-form-grid" novalidate>
                    <article class="profile-card student-overview-card" data-role-card="student">
                        <div class="overview-header">
                            <div>
                                <h2>Student Overview</h2>
                            </div>
                        </div>
                        <div class="student-overview-grid">
                            <div class="overview-identity">
                                <div class="overview-identity-header">
                                    <div class="photo-frame" id="photoFrame">
                                        <img src="" alt="Profile photo" id="profilePhotoImage" style="display:none;">
                                        <span class="photo-initial" id="profilePhotoInitial">?</span>
                                    </div>
                                    <div class="identity-text">
                                        <h3 id="heroName">Loading...</h3>
                                        <p class="hero-role" id="heroRole">CareSim Student</p>
                                        <div class="photo-actions">
                                            <button type="button" class="btn-upload" id="uploadPhotoBtn">Upload Photo</button>
                                            <button type="button" class="btn-remove-picture" id="removePhotoBtn">Remove</button>
                                        </div>
                                        <input type="file" id="profilePhotoInput" accept="image/*" hidden>
                                        <p class="photo-hint">PNG or JPG, max 5MB.</p>
                                    </div>
                                </div>
                                <div class="identity-info-tiles">
                                    <div class="info-tile compact">
                                        <span class="info-tile-label">Student Number</span>
                                        <strong id="studentNumberDisplay">--</strong>
                                        <input type="hidden" id="studentNumber" name="studentNumber">
                                    </div>
                                    <div class="info-tile compact">
                                        <span class="info-tile-label">Batch</span>
                                        <strong id="batchDisplay">--</strong>
                                        <input type="hidden" id="batch" name="batch">
                                    </div>
                                    <div class="info-tile compact status-pill-tile">
                                        <span class="info-tile-label">Status</span>
                                        <span class="status-pill" id="heroStatusLabel">Active</span>
                                        <select id="studentStatus" name="studentStatus" class="status-select" aria-label="Update student status">
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="graduated">Graduated</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="identity-meta">
                                    <span class="meta-label">Last Login</span>
                                    <span class="meta-value" id="heroLastLogin">--</span>
                                </div>
                            </div>
                            <div class="overview-learning">
                                <div class="learning-stats-grid">
                                    <div>
                                        <span>Overall Progress</span>
                                        <strong id="learningProgressStat">0%</strong>
                                    </div>
                                    <div>
                                        <span>Badges Earned</span>
                                        <strong id="badgesEarnedStat">0</strong>
                                    </div>
                                    <div>
                                        <span>Certificates</span>
                                        <strong id="certificatesSidebarStat">0</strong>
                                    </div>
                                    <div>
                                        <span>Simulation Score</span>
                                        <strong id="simulationScoreStat">--</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="overview-progress-row">
                            <div class="overview-progress-label">
                                <span>Profile Completion</span>
                                <strong id="heroCompletion">0%</strong>
                            </div>
                            <div class="overview-progress-bar">
                                <div class="completion-bar-fill" id="completionBarFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </article>
                    <article class="profile-card">
                        <div class="card-header">
                            <h2>Basic Information</h2>
                            <p class="card-subtitle centered-subtitle">Shared across every role for consistent records.</p>
                        </div>
                        <div class="field-grid two-cols">
                            <div class="field-group">
                                <label for="fullName">Full Name</label>
                                <input type="text" id="fullName" name="fullName" autocomplete="name" required>
                            </div>
                            <div class="field-group">
                                <label for="emailAddress">Email Address</label>
                                <input type="email" id="emailAddress" name="email" required>
                            </div>
                        </div>
                        <div class="field-grid two-cols">
                            <div class="field-group">
                                <label for="roleField">Role</label>
                                <input type="text" id="roleField" name="role" readonly>
                            </div>
                            <div class="field-group field-placeholder" aria-hidden="true"></div>
                        </div>
                        <input type="hidden" id="statusField" name="status">
                        <div class="card-inline-actions right">
                            <button type="button" class="btn-save secondary" data-section="basic-info">Save Basic Info</button>
                        </div>
                    </article>

                    <article class="profile-card">
                        <div class="card-header">
                            <h2>Personal Information</h2>
                            <p class="card-subtitle centered-subtitle">Fields necessary for identity and communication.</p>
                        </div>
                        <div class="field-grid two-cols">
                            <div class="field-group">
                                <label for="contactNumber">Contact Number</label>
                                <input type="tel" id="contactNumber" name="contactNumber" maxlength="11" pattern="\d{11}" inputmode="numeric">
                            </div>
                            <div class="field-group">
                                <label for="birthdate">Birthdate</label>
                                <input type="date" id="birthdate" name="birthdate">
                            </div>
                            <div class="field-group">
                                <label for="gender">Gender</label>
                                <select id="gender" name="gender">
                                    <option value="">Select gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="nonbinary">Non-binary</option>
                                    <option value="prefer_not">Prefer not to say</option>
                                </select>
                            </div>
                            <div class="field-group">
                                <label for="emergencyName">Emergency Contact Name</label>
                                <input type="text" id="emergencyName" name="emergencyName" pattern="^[A-Za-z\s]+$">
                            </div>
                            <div class="field-group">
                                <label for="emergencyNumber">Emergency Contact Number</label>
                                <input type="tel" id="emergencyNumber" name="emergencyNumber" maxlength="11" pattern="\d{11}" inputmode="numeric">
                            </div>
                        </div>
                        <div class="field-group">
                            <label for="address">Address</label>
                            <textarea id="address" name="address" rows="3" placeholder="Complete address"></textarea>
                        </div>
                        <div class="card-inline-actions right">
                            <button type="button" class="btn-save secondary" data-section="personal-info">Save Personal Info</button>
                        </div>
                    </article>

                    <article class="profile-card account-settings-card">
                        <div class="card-header account-settings-header">
                            <div class="account-settings-title">
                            <h2>Account Settings</h2>
                            <p class="card-subtitle centered-subtitle">Security options and last activity data.</p>
                        </div>
                            <span class="card-icon lock-icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="5" y="11" width="14" height="9" rx="2" ry="2"></rect>
                                    <path d="M8 11V7a4 4 0 0 1 8 0v4"></path>
                                    <circle cx="12" cy="15" r="1.5"></circle>
                                </svg>
                            </span>
                        </div>
                        <div class="account-settings-body">
                            <div class="account-status-grid">
                                <div class="status-tile">
                                    <span class="status-label">Last Login</span>
                                    <strong class="status-value" id="lastLoginField">--</strong>
                                </div>
                                <div class="status-tile">
                                    <span class="status-label">Profile Completion</span>
                                    <div class="status-value-group">
                                        <strong class="status-value" id="completionField">0%</strong>
                                        <span class="status-badge in-progress" id="completionBadge">In Progress</span>
                                    </div>
                                    <div class="status-progress">
                                        <div class="status-progress-fill" id="completionStatusBar" style="width: 0%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="account-divider" role="presentation"></div>
                            <div class="account-settings-action-row">
                                <button type="button" class="btn-primary btn-lock" id="changePasswordBtn">
                                    Change Password
                                </button>
                            </div>
                        </div>
                    </article>


                    <article class="profile-card role-card" data-role-card="instructor">
                        <div class="card-header">
                            <h2>Instructor Information</h2>
                            <p class="card-subtitle sr-only">Keep your teaching credentials updated.</p>
                        </div>
                        <div class="field-grid two-cols">
                            <div class="field-group">
                                <label for="department">Department</label>
                                <input type="text" id="department" name="department">
                            </div>
                            <div class="field-group">
                                <label for="assignedClass">Assigned Class / Section</label>
                                <input type="text" id="assignedClass" name="assignedClass">
                            </div>
                            <div class="field-group">
                                <label for="experienceYears">Years of Experience</label>
                                <input type="number" id="experienceYears" min="0" max="60">
                            </div>
                            <div class="field-group">
                                <label for="licenseId">License / Certification ID</label>
                                <input type="text" id="licenseId">
                            </div>
                        </div>
                    </article>

                    <article class="profile-card role-card" data-role-card="admin">
                        <div class="card-header">
                            <h2>Admin Information</h2>
                            <p class="card-subtitle">System access metadata.</p>
                        </div>
                        <div class="field-grid two-cols">
                            <div class="field-group">
                                <label for="adminId">Admin ID</label>
                                <input type="text" id="adminId">
                            </div>
                            <div class="field-group">
                                <label for="permissionsLevel">Permissions Level</label>
                                <select id="permissionsLevel">
                                    <option value="standard">Standard</option>
                                    <option value="manager">Manager</option>
                                    <option value="superadmin">Super Admin</option>
                                </select>
                            </div>
                            <div class="field-group">
                                <label for="dateCreated">Date Created</label>
                                <input type="text" id="dateCreated" readonly>
                            </div>
                            <div class="field-group">
                                <label for="createdBy">Created By</label>
                                <input type="text" id="createdBy">
                            </div>
                        </div>
                    </article>

                </form>
            </section>
        </div>
    </div>
    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="history-modal" style="display: none;">
        <div class="history-modal-content logout-modal-content">
            <div class="history-modal-header">
                <h2>Confirm Logout</h2>
                <button class="history-close" onclick="closeLogoutModal()">&times;</button>
            </div>
            <div class="logout-modal-body">
                <p>Are you sure you want to log out?</p>
            </div>
            <div class="modal-actions" style="padding: 20px 24px; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn-secondary" onclick="closeLogoutModal()" style="padding: 10px 20px; background: white; color: #64748B; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Cancel</button>
                <button type="button" class="btn-primary" onclick="confirmLogout()" style="padding: 10px 20px; background: #C19A6B; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Logout</button>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('studentToken') || localStorage.getItem('adminToken') || localStorage.getItem('instructorToken');
        if (!token) {
            window.location.href = '/caresim-login';
        }

        function enforceNumericInput(e) {
            if (!e?.target) return;
            const cleanValue = e.target.value.replace(/\D/g, '').slice(0, 11);
            e.target.value = cleanValue;
        }

        function enforceLetterInput(e) {
            if (!e?.target) return;
            const cleanValue = e.target.value.replace(/[^A-Za-z\s]/g, '');
            e.target.value = cleanValue;
        }

        const state = {
            role: 'student',
            photoFile: null,
            photoUrl: '',
            completion: 0,
            lastLogin: '',
            verification: false
        };

        const dom = {
            form: document.getElementById('profileForm'),
            fullName: document.getElementById('fullName'),
            email: document.getElementById('emailAddress'),
            role: document.getElementById('roleField'),
            status: document.getElementById('statusField'),
            contact: document.getElementById('contactNumber'),
            birthdate: document.getElementById('birthdate'),
            gender: document.getElementById('gender'),
            address: document.getElementById('address'),
            emergencyName: document.getElementById('emergencyName'),
            emergencyNumber: document.getElementById('emergencyNumber'),
            studentNumber: document.getElementById('studentNumber'),
            batch: document.getElementById('batch'),
            studentNumberDisplay: document.getElementById('studentNumberDisplay'),
            batchDisplay: document.getElementById('batchDisplay'),
            studentStatus: document.getElementById('studentStatus'),
            department: document.getElementById('department'),
            assignedClass: document.getElementById('assignedClass'),
            experienceYears: document.getElementById('experienceYears'),
            licenseId: document.getElementById('licenseId'),
            adminId: document.getElementById('adminId'),
            permissionsLevel: document.getElementById('permissionsLevel'),
            dateCreated: document.getElementById('dateCreated'),
            createdBy: document.getElementById('createdBy'),
            lastLoginField: document.getElementById('lastLoginField'),
            completionField: document.getElementById('completionField'),
            heroName: document.getElementById('heroName'),
            heroRole: document.getElementById('heroRole'),
            heroStatus: document.getElementById('heroStatusLabel'),
            heroLastLogin: document.getElementById('heroLastLogin'),
            heroCompletion: document.getElementById('heroCompletion'),
            completionPercent: document.getElementById('completionPercent'),
            progressCircle: document.querySelector('.progress-ring-circle'),
            completionBadge: document.getElementById('completionBadge'),
            completionStatusBar: document.getElementById('completionStatusBar'),
            profilePhotoInput: document.getElementById('profilePhotoInput'),
            photoFrame: document.getElementById('photoFrame'),
            photoImage: document.getElementById('profilePhotoImage'),
            photoInitial: document.getElementById('profilePhotoInitial'),
            learningProgressStat: document.getElementById('learningProgressStat'),
            badgesEarnedStat: document.getElementById('badgesEarnedStat'),
            certificatesSidebarStat: document.getElementById('certificatesSidebarStat'),
            simulationScoreStat: document.getElementById('simulationScoreStat'),
            uploadPhotoBtn: document.getElementById('uploadPhotoBtn'),
            removePhotoBtn: document.getElementById('removePhotoBtn'),
            changePasswordBtn: document.getElementById('changePasswordBtn'),
        };

        if (dom.studentStatus) {
            dom.studentStatus.addEventListener('change', () => {
                if (dom.heroStatus) dom.heroStatus.textContent = capitalize(dom.studentStatus.value || 'active');
            });
        }

        const verificationIcons = {
            verified: `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.25 6.25L8.125 14.375L3.75 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            pending: `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/><path d="M10 5V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`
        };

        function capitalize(text = '') {
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        function setValue(el, value = '') {
            if (!el) return;
            const val = value ?? '';
            const tag = el.tagName?.toLowerCase();
            if (tag === 'input' || tag === 'textarea' || tag === 'select') {
                el.value = val;
            } else {
                el.textContent = val;
            }
        }

        function formatDateTime(value) {
            if (!value) return '--';
            try {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleString();
            } catch {
                return value;
            }
        }

        function updateCompletion(percent = 0) {
            state.completion = Math.max(0, Math.min(100, Number(percent) || 0));
            const rounded = Math.round(state.completion);
            if (dom.heroCompletion) dom.heroCompletion.textContent = `${rounded}%`;
            if (dom.completionField) {
                const tag = dom.completionField.tagName?.toLowerCase();
                if (tag === 'input') dom.completionField.value = `${rounded}%`;
                else dom.completionField.textContent = `${rounded}%`;
            }
            const completionBarFill = document.getElementById('completionBarFill');
            if (completionBarFill) completionBarFill.style.width = `${rounded}%`;
            if (dom.completionStatusBar) dom.completionStatusBar.style.width = `${rounded}%`;
            if (dom.completionBadge) {
                if (rounded >= 100) {
                    dom.completionBadge.textContent = 'Complete';
                    dom.completionBadge.classList.remove('in-progress');
                } else {
                    dom.completionBadge.textContent = 'In Progress';
                    dom.completionBadge.classList.add('in-progress');
                }
            }
        }


        function updatePhotoPreview(src = '', fallbackName = '') {
            if (src) {
                dom.photoImage.src = src;
                dom.photoImage.style.display = 'block';
                dom.photoInitial.style.display = 'none';
                state.photoUrl = src;
            } else {
                dom.photoImage.style.display = 'none';
                dom.photoInitial.style.display = 'flex';
                dom.photoInitial.textContent = (fallbackName || '?').charAt(0).toUpperCase();
                state.photoUrl = '';
            }
        }

        function toggleRoleCards(role) {
            document.querySelectorAll('[data-role-card]').forEach(card => {
                const allowedRoles = card.getAttribute('data-role-card').split(',').map(r => r.trim());
                card.style.display = allowedRoles.includes(role) ? 'block' : 'none';
            });
        }

        function applyFieldPermissions() {
            const isAdmin = state.role === 'admin';
            if (dom.role) dom.role.readOnly = !isAdmin;
            if (dom.studentNumber) dom.studentNumber.readOnly = !isAdmin;
            if (dom.batch) dom.batch.readOnly = !isAdmin;
            if (dom.studentStatus) dom.studentStatus.disabled = !isAdmin;
        }

        function updateLearningSummary(learning = {}) {
            const lessons = learning.lessonsCompleted ?? 0;
            const totalLessons = learning.totalLessons ?? 6;
            const quizzes = learning.quizzesCompleted ?? 0;
            const totalQuizzes = learning.totalQuizzes ?? 6;
            const simulations = learning.simulationsCompleted ?? 0;
            const totalSims = learning.totalSimulations ?? 3;
            const certificates = learning.certificatesEarned ?? 0;
            const totalCerts = learning.totalCertificates ?? 3;
            const badges = learning.badgesEarned ?? certificates;
            const simulationScore = learning.simulationScore ?? '--';
            const progress = learning.overallProgress ?? state.completion;

            if (dom.learningProgressStat) dom.learningProgressStat.textContent = `${Math.round(progress)}%`;
            if (dom.badgesEarnedStat) dom.badgesEarnedStat.textContent = badges;
            if (dom.certificatesSidebarStat) dom.certificatesSidebarStat.textContent = certificates;
            if (dom.simulationScoreStat) dom.simulationScoreStat.textContent = simulationScore;
        }

        async function loadProfile() {
            try {
                const response = await fetch('/api/user/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Handle unauthorized - redirect to login
                if (response.status === 401) {
                    localStorage.removeItem('studentToken');
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('instructorToken');
                    window.location.href = '/caresim-login';
                    return;
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response received:', text.substring(0, 200));
                    showAlertModal(`Server error: Received non-JSON response (Status: ${response.status}). The API endpoint might not be working correctly.`, 'Error');
                    return;
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.error || errorData.message || `Failed to load profile (Status: ${response.status})`;
                    throw new Error(errorMsg);
                }
                
                const payload = await response.json();
                const data = payload.data || payload || {};
                const profile = data.profile || data;
                const learning = data.learning || {};
                const studentInfo = data.studentInfo || {};
                const instructorInfo = data.instructorInfo || {};
                const adminInfo = data.adminInfo || {};
                const emergency = data.emergencyContact || profile.emergencyContact || {};
                const settings = data.settings || {};
                state.role = (data.role || profile.role || 'student').toLowerCase();
                state.lastLogin = settings.lastLogin || data.lastLogin || '';

                setValue(dom.fullName, profile.name || profile.fullName || '');
                setValue(dom.email, data.email || profile.email || '');
                setValue(dom.role, capitalize(state.role));
                setValue(dom.status, data.status || profile.status || 'active');
                setValue(dom.contact, profile.contact || profile.contactNumber || '');
                setValue(dom.birthdate, profile.birthdate || profile.birthday || '');
                setValue(dom.gender, profile.gender || '');
                setValue(dom.address, profile.address || '');
                setValue(dom.emergencyName, emergency.name || '');
                setValue(dom.emergencyNumber, emergency.contact || emergency.number || '');

                setValue(dom.studentNumber, studentInfo.studentNumber || profile.studentNumber || '');
                setValue(dom.batch, studentInfo.batch || profile.batch || '');
                if (dom.studentNumberDisplay) dom.studentNumberDisplay.textContent = dom.studentNumber.value || '--';
                if (dom.batchDisplay) dom.batchDisplay.textContent = dom.batch.value || '--';
                setValue(dom.studentStatus, studentInfo.status || profile.status || 'active');

                setValue(dom.department, instructorInfo.department || '');
                setValue(dom.assignedClass, instructorInfo.assignedClass || '');
                setValue(dom.experienceYears, instructorInfo.yearsOfExperience || '');
                setValue(dom.licenseId, instructorInfo.licenseId || '');

                setValue(dom.adminId, adminInfo.adminId || data.adminId || '');
                setValue(dom.permissionsLevel, adminInfo.permissionsLevel || 'standard');
                setValue(dom.dateCreated, formatDateTime(adminInfo.dateCreated || data.createdAt || ''));
                setValue(dom.createdBy, adminInfo.createdBy || '');

                if (dom.heroName) dom.heroName.textContent = profile.name || profile.fullName || 'CareSim User';
                if (dom.heroRole) dom.heroRole.textContent = 'CareSim Student';
                if (dom.heroStatus) dom.heroStatus.textContent = capitalize(data.status || profile.status || 'active');
                if (dom.heroLastLogin) dom.heroLastLogin.textContent = formatDateTime(state.lastLogin);
                setValue(dom.lastLoginField, formatDateTime(state.lastLogin));

                updateLearningSummary(learning);
                updateCompletion(data.profileCompletion ?? settings.profileCompletion ?? learning.overallProgress ?? 0);

                const pictureUrl = profile.pictureURL || data.pictureURL || '';
                updatePhotoPreview(pictureUrl, profile.name || '');

                toggleRoleCards(state.role);
                applyFieldPermissions();
            } catch (error) {
                console.error('Error loading profile:', error);
                const errorMessage = error.message || 'Unable to load profile information. Please try again.';
                showAlertModal(errorMessage, 'Error');
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const contactValue = dom.contact.value.trim();
            if (!/^\d{11}$/.test(contactValue)) {
                showAlertModal('Contact number must be exactly 11 digits.', 'Validation');
                dom.contact.focus();
                return;
            }
            const emergencyNumberValue = dom.emergencyNumber.value.trim();
            if (emergencyNumberValue && !/^\d{11}$/.test(emergencyNumberValue)) {
                showAlertModal('Emergency contact number must be exactly 11 digits.', 'Validation');
                dom.emergencyNumber.focus();
                return;
            }
            const emergencyNameValue = dom.emergencyName.value.trim();
            if (emergencyNameValue && !/^[A-Za-z\s]+$/.test(emergencyNameValue)) {
                showAlertModal('Emergency contact name should contain letters and spaces only.', 'Validation');
                dom.emergencyName.focus();
                return;
            }
            const payload = {
                role: state.role,
                email: dom.email.value,
                status: dom.status.value,
                profile: {
                    name: dom.fullName.value,
                    fullName: dom.fullName.value,
                    contact: dom.contact.value,
                    contactNumber: dom.contact.value,
                    birthdate: dom.birthdate.value,
                    gender: dom.gender.value,
                    address: dom.address.value,
                    emergencyContact: {
                        name: dom.emergencyName.value,
                        contact: dom.emergencyNumber.value
                    }
                },
                settings: {
                    lastLogin: state.lastLogin,
                    profileCompletion: state.completion
                }
            };

            if (state.role === 'student') {
                payload.studentInfo = {
                    studentNumber: dom.studentNumber.value,
                    batch: dom.batch.value,
                    status: dom.studentStatus.value
                };
            }
            if (state.role === 'instructor') {
                payload.instructorInfo = {
                    department: dom.department.value,
                    assignedClass: dom.assignedClass.value,
                    yearsOfExperience: dom.experienceYears.value,
                    licenseId: dom.licenseId.value
                };
            }
            if (state.role === 'admin') {
                payload.adminInfo = {
                    adminId: dom.adminId.value,
                    permissionsLevel: dom.permissionsLevel.value,
                    dateCreated: dom.dateCreated.value,
                    createdBy: dom.createdBy.value
                };
            }

            if (state.photoFile) {
                payload.profile.photoUpload = await fileToBase64(state.photoFile);
            }
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to save profile');
                }
                    showAlertModal('Profile updated successfully!', 'Success');
                loadProfile();
                state.photoFile = null;
            } catch (error) {
                console.error('Error saving profile:', error);
                showAlertModal(error.message || 'Unable to save profile. Please try again.', 'Error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function handlePhotoSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            state.photoFile = file;
            const reader = new FileReader();
            reader.onload = () => updatePhotoPreview(reader.result, dom.fullName.value);
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            state.photoFile = null;
            dom.profilePhotoInput.value = '';
            updatePhotoPreview('', dom.fullName.value);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('profile-dark');
            const isDark = document.body.classList.contains('profile-dark');
            dom.darkModeToggle.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
        
        function showAlertModal(message, title = 'Notice') {
            const modal = document.getElementById('alertModal');
            const msg = document.getElementById('alertMessage');
            const ttl = document.getElementById('alertTitle');
            if (!modal || !msg || !ttl) return alert(message);
            ttl.textContent = title;
            msg.textContent = message;
            modal.style.display = 'flex';
        }

        function closeAlertModal() {
            const modal = document.getElementById('alertModal');
            if (modal) modal.style.display = 'none';
        }

        function goToDashboard() {
            window.location.href = '/student-dashboard?refresh=' + Date.now();
        }

        function logout() {
            document.getElementById('logoutModal').style.display = 'flex';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function confirmLogout() {
            ['studentToken', 'adminToken', 'instructorToken', 'studentData'].forEach(key => localStorage.removeItem(key));
            window.location.href = '/caresim-login';
        }

        window.onclick = function(event) {
            const logoutModal = document.getElementById('logoutModal');
            const alertModal = document.getElementById('alertModal');
            if (event.target === logoutModal) closeLogoutModal();
            if (event.target === alertModal) closeAlertModal();
        };

        if (dom.form) dom.form.addEventListener('submit', handleFormSubmit);
        if (dom.contact) dom.contact.addEventListener('input', enforceNumericInput);
        if (dom.emergencyNumber) dom.emergencyNumber.addEventListener('input', enforceNumericInput);
        if (dom.emergencyName) dom.emergencyName.addEventListener('input', enforceLetterInput);
        if (dom.uploadPhotoBtn && dom.profilePhotoInput) {
            dom.uploadPhotoBtn.addEventListener('click', () => dom.profilePhotoInput.click());
        }
        if (dom.profilePhotoInput) dom.profilePhotoInput.addEventListener('change', handlePhotoSelection);
        if (dom.removePhotoBtn) dom.removePhotoBtn.addEventListener('click', removePhoto);
        if (dom.changePasswordBtn) {
            dom.changePasswordBtn.addEventListener('click', () => showAlertModal('Use the security menu to change your password.', 'Heads up'));
        }

        loadProfile();
    </script>
</body>
<!-- Alert Modal -->
<div id="alertModal" class="history-modal" style="display: none;">
    <div class="history-modal-content">
        <div class="history-modal-header">
            <h2 id="alertTitle">Notice</h2>
            <button class="history-close" onclick="closeAlertModal()">&times;</button>
        </div>
        <div class="history-modal-body">
            <p id="alertMessage"></p>
        </div>
        <div class="modal-actions" style="padding: 20px 24px; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 12px;">
            <button type="button" class="btn-primary" onclick="closeAlertModal()" style="padding: 10px 20px; background: #C19A6B; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">OK</button>
        </div>
    </div>
</div>
</html>
