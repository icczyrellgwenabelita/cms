<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareSim Student Portal</title>
    <link rel="icon" type="image/png" sizes="32x32" href="asat.png">
    <link rel="icon" type="image/png" sizes="16x16" href="asat.png">
    <link rel="shortcut icon" type="image/png" href="asat.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="student-portal.css">
</head>
<body class="student-portal">
    <!-- Header / Navigation -->
    <header class="portal-header">
        <div class="header-content">
            <div class="logo">
                <img src="caresimm.png" alt="CareSim" class="header-logo">
            </div>
            <div class="header-right">
                <nav class="nav-tabs">
                    <a href="/student-dashboard" class="nav-tab active">Dashboard</a>
                    <a href="/student-profile" class="nav-tab">Profile</a>
                </nav>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>
    <div class="portal-container">
        <!-- Profile Section (Left Sidebar) -->
        <aside class="profile-sidebar">
            <div class="profile-card">
                <div class="profile-header">
                    <h3>Personal details</h3>
                    <div id="verifiedBadge" class="badge-container" style="display: none;">
                        <span class="verified-badge">‚úÖ Verified Student</span>
                    </div>
                </div>
                
                <h2 class="profile-name" id="profileName">Loading...</h2>
                <p class="profile-email" id="profileEmail"></p>
                
                <!-- Profile Details -->
                <div class="profile-details" id="profileDetails">
                    <div class="detail-item" id="genderItem" style="display: none;">
                        <span class="detail-label">Gender:</span>
                        <span class="detail-value" id="genderValue"></span>
                    </div>
                    <div class="detail-item" id="studentNumberItem" style="display: none;">
                        <span class="detail-label">Student Number:</span>
                        <span class="detail-value" id="studentNumberValue"></span>
                    </div>
                    <div class="detail-item" id="batchItem" style="display: none;">
                        <span class="detail-label">Batch:</span>
                        <span class="detail-value" id="batchValue"></span>
                    </div>
                    <div class="detail-item" id="contactNumberItem" style="display: none;">
                        <span class="detail-label">Contact Number:</span>
                        <span class="detail-value" id="contactNumberValue"></span>
                    </div>
                    <div class="detail-item" id="birthdayItem" style="display: none;">
                        <span class="detail-label">Birthday:</span>
                        <span class="detail-value" id="birthdayValue"></span>
                    </div>
                    <div class="detail-item" id="addressItem" style="display: none;">
                        <span class="detail-label">Address:</span>
                        <span class="detail-value" id="addressValue"></span>
                    </div>
                </div>
                
                
                <div class="progress-bar-container">
                    <div class="progress-label">
                        <span>Profile Completion</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </aside>
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Verification Callout -->
            <div id="verificationBanner" class="verification-banner" style="display: none;">
                <div class="banner-content">
                    <span class="banner-icon">üéØ</span>
                    <p>Complete your profile to become a Verified CareSim Student and unlock special game rewards!</p>
                    <button class="btn-banner" onclick="goToProfile()">Go to Profile</button>
                </div>
            </div>
            <!-- Lesson Progress Section -->
            <section class="lessons-section">
                <h1 class="section-title">Lesson Progress</h1>
                <div class="lessons-grid" id="lessonsContainer">
                    <!-- Lesson cards will be inserted here -->
                </div>
            </section>
            <!-- Certificates Section -->
            <section class="certificates-section">
                <h1 class="section-title">üéì Certificates</h1>
                <div class="certificates-grid" id="certificatesContainer">
                    <!-- Certificates will be inserted here -->
                </div>
            </section>
        </main>
    </div>
    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="history-modal" style="display: none;">
        <div class="history-modal-content logout-modal-content">
            <div class="history-modal-header">
                <h2>Confirm Logout</h2>
                <button class="history-close" onclick="closeLogoutModal()">&times;</button>
            </div>
            <div class="logout-modal-body">
                <p>Are you sure you want to log out?</p>
            </div>
            <div class="modal-actions" style="padding: 20px 24px; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn-secondary" onclick="closeLogoutModal()" style="padding: 10px 20px; background: white; color: #64748B; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Cancel</button>
                <button type="button" class="btn-primary" onclick="confirmLogout()" style="padding: 10px 20px; background: #C19A6B; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Logout</button>
            </div>
        </div>
    </div>
    <!-- History Modal -->
    <div id="historyModal" class="history-modal" style="display: none;">
        <div class="history-modal-content">
            <div class="history-modal-header">
                <h2 id="historyTitle">Quiz History</h2>
                <button class="history-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="history-modal-body">
                <div class="history-list" id="historyList">
                    <!-- History items will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('studentToken');
        
        if (!token) {
            window.location.href = '/student-login';
        }
        async function loadDashboard() {
            try {
                const response = await fetch('/api/user/dashboard?t=' + Date.now(), {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                const data = await response.json();
                
                console.log('Dashboard API Response:', data);
                console.log('Dashboard Response Status:', response.status);
                console.log('Dashboard Lessons:', data.data?.lessons);
                if (response.ok) {
                    document.getElementById('profileName').textContent = data.data.name || data.data.fullName || data.data.email || 'User';
                    document.getElementById('profileEmail').textContent = data.data.email || '';
                    
                    const details = data.data;
                    
                    if (details.gender) {
                        document.getElementById('genderValue').textContent = details.gender.charAt(0).toUpperCase() + details.gender.slice(1);
                        document.getElementById('genderItem').style.display = 'flex';
                    } else {
                        document.getElementById('genderItem').style.display = 'none';
                    }
                    
                    if (details.studentNumber) {
                        document.getElementById('studentNumberValue').textContent = details.studentNumber;
                        document.getElementById('studentNumberItem').style.display = 'flex';
                    } else {
                        document.getElementById('studentNumberItem').style.display = 'none';
                    }
                    
                    if (details.batch) {
                        document.getElementById('batchValue').textContent = details.batch;
                        document.getElementById('batchItem').style.display = 'flex';
                    } else {
                        document.getElementById('batchItem').style.display = 'none';
                    }
                    
                    if (details.contactNumber) {
                        document.getElementById('contactNumberValue').textContent = details.contactNumber;
                        document.getElementById('contactNumberItem').style.display = 'flex';
                    } else {
                        document.getElementById('contactNumberItem').style.display = 'none';
                    }
                    
                    if (details.birthday) {
                        const birthdayDate = new Date(details.birthday);
                        const formattedDate = birthdayDate.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        document.getElementById('birthdayValue').textContent = formattedDate;
                        document.getElementById('birthdayItem').style.display = 'flex';
                    } else {
                        document.getElementById('birthdayItem').style.display = 'none';
                    }
                    
                    if (details.address) {
                        document.getElementById('addressValue').textContent = details.address;
                        document.getElementById('addressItem').style.display = 'flex';
                    } else {
                        document.getElementById('addressItem').style.display = 'none';
                    }
                    
                    const progressPercent = data.data.profileCompletion || 0;
                    document.getElementById('progressPercent').textContent = progressPercent + '%';
                    document.getElementById('progressFill').style.width = progressPercent + '%';
                    
                    const verifiedBadgeEl = document.getElementById('verifiedBadge');
                    const verificationMsgEl = document.getElementById('verificationMessage');
                    const verificationBannerEl = document.getElementById('verificationBanner');
                    if (data.data.isVerified || data.data.verified) {
                        if (verifiedBadgeEl) verifiedBadgeEl.style.display = 'block';
                        if (verificationMsgEl) verificationMsgEl.style.display = 'none';
                        if (verificationBannerEl) verificationBannerEl.style.display = 'none';
                    } else {
                        if (verifiedBadgeEl) verifiedBadgeEl.style.display = 'none';
                        if (verificationMsgEl) verificationMsgEl.style.display = 'block';
                        if (verificationBannerEl) verificationBannerEl.style.display = 'flex';
                    }
                    
                    
                    loadLessons(data.data.lessons || []);
                    
                    loadCertificates(data.data.certificates || []);
                } else {
                    console.error('Dashboard API Error:', data);
                    console.error('Response status:', response.status);
                    if (response.status === 401) {
                        console.log('Unauthorized - logging out');
                        logout();
                    } else {
                        showAlertModal('Failed to load dashboard: ' + (data.error || 'Unknown error'), 'Error');
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                console.error('Error details:', error.message);
                showAlertModal('Error loading dashboard: ' + error.message, 'Error');
            }
        }
        async function loadLessons(lessons) {
            const container = document.getElementById('lessonsContainer');
            if (!container) {
                console.error('Lessons container not found');
                return;
            }
            const slotToLesson = {};
            (lessons || []).forEach(l => {
                if (l && typeof l === 'object' && 'slot' in l) {
                    slotToLesson[l.slot] = l;
                }
            });
            const normalizedLessons = [];
            for (let i = 1; i <= 6; i++) {
                const l = slotToLesson[i] || { slot: i };
                normalizedLessons.push(l);
            }
            const formatTime = (seconds) => {
                if (seconds === null || seconds === undefined || typeof seconds !== 'number' || isNaN(seconds)) {
                    return 'No attempts yet';
                }
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}m ${secs}s`;
            };
            
            const getValue = (value) => {
                if (value !== null && value !== undefined && typeof value === 'number' && !isNaN(value)) {
                    return value;
                }
                return 'No attempts yet';
            };
            
            const formatScore = (score) => {
                if (score !== null && score !== undefined && typeof score === 'number' && !isNaN(score)) {
                    return `${score} out of 10`;
                }
                return 'No attempts yet';
            };
            
            const cardsHtml = normalizedLessons.map(lesson => {
                const analyticsRows = `
                    <div class="analytics-row">
                        <span class="analytics-label">Recent Quiz Score:</span>
                        <span class="analytics-value">${formatScore(lesson.recentQuizScore)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Highest Quiz Score:</span>
                        <span class="analytics-value">${formatScore(lesson.highestQuizScore)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Quiz Attempts:</span>
                        <span class="analytics-value">${getValue(lesson.quizAttempts)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Average Quiz Score:</span>
                        <span class="analytics-value">${formatScore(lesson.avgQuizScore)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Avg Time (Quiz):</span>
                        <span class="analytics-value">${formatTime(lesson.avgQuizTime)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Avg Time (Simulation):</span>
                        <span class="analytics-value">${formatTime(lesson.avgSimTime)}</span>
                    </div>
                `;
                let statusHtml = '';
                const statusValue = (lesson && typeof lesson.status === 'string' && lesson.status.trim() !== '')
                    ? lesson.status.trim()
                    : 'not_started';
                if (statusValue === 'completed') {
                    statusHtml = `<span class="lesson-status completed">‚úì Completed</span>`;
                } else if (statusValue === 'in_progress') {
                    statusHtml = `<span class="lesson-status in-progress">‚óè In Progress</span>`;
                } else {
                    statusHtml = `<span class="lesson-status not-started">‚óã Not Started</span>`;
                }
                const lessonName = (lesson && lesson.lessonName) ? lesson.lessonName : `Lesson ${lesson.slot}`;
                const lessonSlot = lesson.slot || 0;
                const hasQuizAttempts = lesson.quizAttempts && lesson.quizAttempts > 0;
                const simAttemptsCount = Number(lesson.simAttempts) || 0;
                const hasSimHistory = Array.isArray(lesson.simHistory) && lesson.simHistory.length > 0;
                const normalizedAvgSimTime = (typeof lesson.avgSimTime === 'number' && !isNaN(lesson.avgSimTime)) ? lesson.avgSimTime : Number(lesson.avgSimTime) || 0;
                const hasSimAttempts = simAttemptsCount > 0 || normalizedAvgSimTime > 0 || hasSimHistory;
                const quizHistoryData = (lesson.quizHistory && Array.isArray(lesson.quizHistory)) 
                    ? encodeURIComponent(JSON.stringify(lesson.quizHistory)) 
                    : encodeURIComponent(JSON.stringify([]));
                const simHistoryData = (lesson.simHistory && Array.isArray(lesson.simHistory)) 
                    ? encodeURIComponent(JSON.stringify(lesson.simHistory)) 
                    : encodeURIComponent(JSON.stringify([]));
                const simSummaryData = encodeURIComponent(JSON.stringify({
                    attempts: simAttemptsCount,
                    avgTime: normalizedAvgSimTime
                }));
                
                return `
                    <div class="lesson-card">
                        <div class="lesson-header">
                            <h3>${lessonName}</h3>
                            ${statusHtml}
                        </div>
                        <div class="lesson-analytics">
                            ${analyticsRows}
                        </div>
                        <div class="lesson-actions">
                            <button class="btn-history" data-lesson-slot="${lessonSlot}" data-history="${quizHistoryData}" data-type="quiz" ${hasQuizAttempts ? '' : 'disabled'}>
                                Quiz History
                            </button>
                            <button class="btn-history" data-lesson-slot="${lessonSlot}" data-history="${simHistoryData}" data-summary="${simSummaryData}" data-type="simulation" ${hasSimAttempts ? '' : 'disabled'}>
                                Simulation History
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = cardsHtml;
            console.log('Rendered lesson cards:', normalizedLessons.length);
            if (!cardsHtml || cardsHtml.trim() === '') {
                console.warn('No lesson cards HTML generated, rendering fallback');
                container.innerHTML = '<p class="empty-state">No lessons to display.</p>';
            }
            
            container.querySelectorAll('.btn-history').forEach(button => {
                button.addEventListener('click', function() {
                    if (this.disabled) return;
                    const lessonSlot = parseInt(this.getAttribute('data-lesson-slot'));
                    const historyData = this.getAttribute('data-history');
                    const historyType = this.getAttribute('data-type') || 'quiz';
                    const summaryAttr = this.getAttribute('data-summary');
                    let history = [];
                    if (historyData) {
                        try {
                            history = JSON.parse(decodeURIComponent(historyData));
                        } catch (e) {
                            console.error('Error parsing history data:', e);
                        }
                    }
                    let summaryInfo = null;
                    if (summaryAttr) {
                        try {
                            summaryInfo = JSON.parse(decodeURIComponent(summaryAttr));
                        } catch (e) {
                            console.error('Error parsing summary data:', e);
                        }
                    }
                    showHistory(lessonSlot, history, historyType, summaryInfo);
                });
            });
        }
        function loadCertificates(certificates) {
            const container = document.getElementById('certificatesContainer');
            if (!container) {
                console.error('Certificates container not found');
                return;
            }
            
            if (certificates.length === 0) {
                container.innerHTML = '<p class="empty-state">No certificates yet. Keep progressing!</p>';
                return;
            }
            container.innerHTML = certificates.map(cert => `
                <div class="certificate-card">
                    <div class="certificate-icon">üéì</div>
                    <h3>${cert.title || cert.name || 'Certificate'}</h3>
                    <p class="certificate-date">Issued: ${cert.date || 'N/A'}</p>
                    <div class="certificate-actions">
                        <button class="btn-certificate" onclick="viewCertificate('${cert.id || ''}')">View</button>
                        <button class="btn-certificate" onclick="downloadCertificate('${cert.id || ''}')">Download</button>
                    </div>
                </div>
            `).join('');
        }
        function viewCertificate(certId) {
            showAlertModal(`Viewing certificate ${certId}`, 'Notice');
        }
        function downloadCertificate(certId) {
            showAlertModal(`Downloading certificate ${certId}`, 'Notice');
        }
        function goToProfile() {
            window.location.href = '/student-profile';
        }
        window.loadDashboard = loadDashboard;
        function toggleProfileMenu() {
            showAlertModal('Profile menu', 'Notice');
        }
        function logout() {
            document.getElementById('logoutModal').style.display = 'flex';
        }
        
        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }
        
        function confirmLogout() {
            localStorage.removeItem('studentToken');
            localStorage.removeItem('studentData');
            window.location.href = '/student-login';
        }
        function formatSimulationDuration(seconds) {
            if (seconds === null || seconds === undefined || typeof seconds !== 'number' || isNaN(seconds) || seconds <= 0) {
                return 'No attempts yet';
            }
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}m ${secs}s`;
        }
        function showHistory(lessonSlot, historyData, historyType = 'quiz', summaryInfo = null) {
            const historyModal = document.getElementById('historyModal');
            const historyTitle = document.getElementById('historyTitle');
            const historyList = document.getElementById('historyList');
            
            if (!historyModal) {
                console.error('History modal not found');
                return;
            }
            
            const typeLabel = historyType === 'simulation' ? 'Simulation' : 'Quiz';
            historyTitle.textContent = `${typeLabel} History - Lesson ${lessonSlot}`;
            
            const history = Array.isArray(historyData) ? historyData : [];
            
            if (history.length === 0) {
                if (historyType === 'simulation' && summaryInfo && Number(summaryInfo.attempts) > 0) {
                    historyList.innerHTML = `
                        <div class="history-item-new">
                            <div class="history-header">
                                <span class="history-date">Attempts: ${summaryInfo.attempts}</span>
                                <span class="history-time-label">Average Duration</span>
                            </div>
                            <div class="history-body">
                                <span class="history-duration">${formatSimulationDuration(summaryInfo.avgTime)}</span>
                            </div>
                        </div>
                    `;
                } else {
                    historyList.innerHTML = `<p class="empty-history">No ${historyType} history available</p>`;
                }
            } else {
                historyList.innerHTML = history.map((entry, index) => {
                    const date = entry.date || 'N/A';
                    const time = entry.time || 'N/A';
                    const duration = entry.duration || 'N/A';
                    
                    if (historyType === 'quiz') {
                        const scoreText = entry.scoreText || (entry.score !== undefined ? `${entry.score} out of 10` : 'N/A');
                        return `
                            <div class="history-item-new">
                                <div class="history-header">
                                    <span class="history-date">${date}</span>
                                    <span class="history-time-label">${time}</span>
                                </div>
                                <div class="history-body">
                                    <span class="history-duration">${duration}</span>
                                    <span class="history-score-text">${scoreText}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        const resultText = entry.result ? `<span class="history-score-text">Result: ${entry.result}</span>` : '';
                        return `
                            <div class="history-item-new">
                                <div class="history-header">
                                    <span class="history-date">${date}</span>
                                    <span class="history-time-label">${time}</span>
                                </div>
                                <div class="history-body">
                                    <span class="history-duration">Duration: ${duration}</span>
                                    ${resultText}
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
            
            historyModal.style.display = 'flex';
        }
        function closeHistoryModal() {
            const historyModal = document.getElementById('historyModal');
            if (historyModal) {
                historyModal.style.display = 'none';
            }
        }
        window.onclick = function(event) {
            const historyModal = document.getElementById('historyModal');
            const logoutModal = document.getElementById('logoutModal');
            if (event.target === historyModal) {
                closeHistoryModal();
            }
            if (event.target === logoutModal) {
                closeLogoutModal();
            }
        };
        loadDashboard();
        
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('refresh')) {
            console.log('Refresh parameter detected, reloading dashboard data');
            setTimeout(() => {
                loadDashboard();
            }, 100);
        }
    </script>
    <!-- Alert Modal -->
    <div id="alertModal" class="history-modal" style="display: none;">
        <div class="history-modal-content">
            <div class="history-modal-header">
                <h2 id="alertTitle">Notice</h2>
                <button class="history-close" onclick="closeAlertModal()">&times;</button>
            </div>
            <div class="history-modal-body">
                <p id="alertMessage"></p>
            </div>
            <div class="modal-actions" style="padding: 20px 24px; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn-primary" onclick="closeAlertModal()" style="padding: 10px 20px; background: #C19A6B; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">OK</button>
            </div>
        </div>
    </div>
    <script>
        function showAlertModal(message, title = 'Notice') {
            const modal = document.getElementById('alertModal');
            if (!modal) return alert(message);
            const titleEl = document.getElementById('alertTitle');
            const msgEl = document.getElementById('alertMessage');
            if (titleEl) titleEl.textContent = title;
            if (msgEl) msgEl.textContent = message;
            modal.style.display = 'flex';
        }
        function closeAlertModal() {
            const modal = document.getElementById('alertModal');
            if (modal) modal.style.display = 'none';
        }
    </script>
    
</body>
</html>