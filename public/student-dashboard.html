<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASAT Student Portal</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="student-portal.css">
</head>
<body class="student-portal">
    <!-- Header / Navigation -->
    <header class="portal-header">
        <div class="header-content">
            <div class="logo">ASAT</div>
            <div class="header-right">
                <nav class="nav-tabs">
                    <a href="student-dashboard.html" class="nav-tab active">Dashboard</a>
                    <a href="student-profile.html" class="nav-tab">Profile</a>
                </nav>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="portal-container">
        <!-- Profile Section (Left Sidebar) -->
        <aside class="profile-sidebar">
            <div class="profile-card">
                <div class="profile-header">
                    <h3>Personal details</h3>
                </div>
                
                <h2 class="profile-name" id="profileName">Loading...</h2>
                <p class="profile-email" id="profileEmail"></p>
                
                <!-- Profile Details -->
                <div class="profile-details" id="profileDetails">
                    <div class="detail-item" id="genderItem" style="display: none;">
                        <span class="detail-label">Gender:</span>
                        <span class="detail-value" id="genderValue"></span>
                    </div>
                    <div class="detail-item" id="studentNumberItem" style="display: none;">
                        <span class="detail-label">Student Number:</span>
                        <span class="detail-value" id="studentNumberValue"></span>
                    </div>
                    <div class="detail-item" id="batchItem" style="display: none;">
                        <span class="detail-label">Batch:</span>
                        <span class="detail-value" id="batchValue"></span>
                    </div>
                    <div class="detail-item" id="contactNumberItem" style="display: none;">
                        <span class="detail-label">Contact Number:</span>
                        <span class="detail-value" id="contactNumberValue"></span>
                    </div>
                    <div class="detail-item" id="birthdayItem" style="display: none;">
                        <span class="detail-label">Birthday:</span>
                        <span class="detail-value" id="birthdayValue"></span>
                    </div>
                    <div class="detail-item" id="addressItem" style="display: none;">
                        <span class="detail-label">Address:</span>
                        <span class="detail-value" id="addressValue"></span>
                    </div>
                </div>
                
                <div class="profile-badge-section">
                    <div id="verifiedBadge" class="badge-container" style="display: none;">
                        <span class="verified-badge">‚úÖ Verified Student</span>
                    </div>
                    <div id="verificationMessage" class="verification-message">
                        <p>Complete your information to get verified as an ASAT student</p>
                        <button class="btn-verify" onclick="goToProfile()">Complete Profile</button>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-label">
                        <span>Profile Completion</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Verification Callout -->
            <div id="verificationBanner" class="verification-banner" style="display: none;">
                <div class="banner-content">
                    <span class="banner-icon">üéØ</span>
                    <p>Complete your profile to become a Verified ASAT Student and unlock special game rewards!</p>
                    <button class="btn-banner" onclick="goToProfile()">Go to Profile</button>
                </div>
            </div>

            <!-- Lesson Progress Section -->
            <section class="lessons-section">
                <h1 class="section-title">Lesson Progress</h1>
                <div class="lessons-grid" id="lessonsContainer">
                    <!-- Lesson cards will be inserted here -->
                </div>
            </section>

            <!-- Certificates Section -->
            <section class="certificates-section">
                <h1 class="section-title">üéì Certificates</h1>
                <div class="certificates-grid" id="certificatesContainer">
                    <!-- Certificates will be inserted here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        const token = localStorage.getItem('studentToken');
        
        if (!token) {
            window.location.href = 'student-login.html';
        }

        async function loadDashboard() {
            try {
                // Add timestamp to prevent caching
                const response = await fetch('/api/student/dashboard?t=' + Date.now(), {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Update profile info
                    document.getElementById('profileName').textContent = data.data.fullName || data.data.email;
                    document.getElementById('profileEmail').textContent = data.data.email;
                    
                    // Update profile details
                    const details = data.data;
                    
                    // Gender
                    if (details.gender) {
                        document.getElementById('genderValue').textContent = details.gender.charAt(0).toUpperCase() + details.gender.slice(1);
                        document.getElementById('genderItem').style.display = 'flex';
                    } else {
                        document.getElementById('genderItem').style.display = 'none';
                    }
                    
                    // Student Number
                    if (details.studentNumber) {
                        document.getElementById('studentNumberValue').textContent = details.studentNumber;
                        document.getElementById('studentNumberItem').style.display = 'flex';
                    } else {
                        document.getElementById('studentNumberItem').style.display = 'none';
                    }
                    
                    // Batch
                    if (details.batch) {
                        document.getElementById('batchValue').textContent = details.batch;
                        document.getElementById('batchItem').style.display = 'flex';
                    } else {
                        document.getElementById('batchItem').style.display = 'none';
                    }
                    
                    // Contact Number
                    if (details.contactNumber) {
                        document.getElementById('contactNumberValue').textContent = details.contactNumber;
                        document.getElementById('contactNumberItem').style.display = 'flex';
                    } else {
                        document.getElementById('contactNumberItem').style.display = 'none';
                    }
                    
                    // Birthday
                    if (details.birthday) {
                        const birthdayDate = new Date(details.birthday);
                        const formattedDate = birthdayDate.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        document.getElementById('birthdayValue').textContent = formattedDate;
                        document.getElementById('birthdayItem').style.display = 'flex';
                    } else {
                        document.getElementById('birthdayItem').style.display = 'none';
                    }
                    
                    // Address
                    if (details.address) {
                        document.getElementById('addressValue').textContent = details.address;
                        document.getElementById('addressItem').style.display = 'flex';
                    } else {
                        document.getElementById('addressItem').style.display = 'none';
                    }
                    
                    // Update progress
                    const progressPercent = data.data.profileCompletion || 0;
                    document.getElementById('progressPercent').textContent = progressPercent + '%';
                    document.getElementById('progressFill').style.width = progressPercent + '%';
                    
                    // Show/hide verification badge
                    if (data.data.isVerified) {
                        document.getElementById('verifiedBadge').style.display = 'block';
                        document.getElementById('verificationMessage').style.display = 'none';
                        document.getElementById('verificationBanner').style.display = 'none';
                    } else {
                        document.getElementById('verifiedBadge').style.display = 'none';
                        document.getElementById('verificationMessage').style.display = 'block';
                        document.getElementById('verificationBanner').style.display = 'flex';
                    }
                    
                    // Profile picture feature removed per request
                    
                    // Load lessons with analytics
                    loadLessons(data.data.lessons || []);
                    
                    // Load certificates
                    loadCertificates(data.data.certificates || []);
                } else {
                    if (response.status === 401) {
                        logout();
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadLessons(lessons) {
            const container = document.getElementById('lessonsContainer');

            // Ensure we always have 6 lesson slots (1..6)
            const slotToLesson = {};
            (lessons || []).forEach(l => {
                if (l && typeof l === 'object' && 'slot' in l) {
                    slotToLesson[l.slot] = l;
                }
            });

            const normalizedLessons = [];
            for (let i = 1; i <= 6; i++) {
                const l = slotToLesson[i] || { slot: i };
                normalizedLessons.push(l);
            }

            // Render 6 cards with the 5 analytics fields (N/A when missing)
            container.innerHTML = normalizedLessons.map(lesson => {
                // Always show these 5 fields, display "N/A" if no data exists
                
                // Helper function to get value or N/A
                const getValue = (value, isPercentage = false) => {
                    if (value !== null && value !== undefined && typeof value === 'number' && !isNaN(value)) {
                        return isPercentage ? `${value}%` : `${value} min`;
                    }
                    return 'N/A';
                };
                
                // Build analytics rows - always show all 5 fields
                const analyticsRows = `
                    <div class="analytics-row">
                        <span class="analytics-label">Quiz Score:</span>
                        <span class="analytics-value">${getValue(lesson.quizScore, true)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Average Quiz Grade :</span>
                        <span class="analytics-value">${getValue(lesson.avgClassGrade, true)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Highest Quiz Grade:</span>
                        <span class="analytics-value">${getValue(lesson.highestGrade, true)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Avg Time (Quiz):</span>
                        <span class="analytics-value">${getValue(lesson.avgQuizTime, false)}</span>
                    </div>
                    <div class="analytics-row">
                        <span class="analytics-label">Avg Time (Simulation):</span>
                        <span class="analytics-value">${getValue(lesson.avgSimTime, false)}</span>
                    </div>
                `;

                // Determine status display (default to Not Started when missing)
                let statusHtml = '';
                const statusValue = (lesson && typeof lesson.status === 'string' && lesson.status.trim() !== '')
                    ? lesson.status.trim()
                    : 'not_started';

                if (statusValue === 'completed') {
                    statusHtml = `<span class="lesson-status completed">‚úì Completed</span>`;
                } else if (statusValue === 'in_progress') {
                    statusHtml = `<span class="lesson-status in-progress">‚óè In Progress</span>`;
                } else {
                    statusHtml = `<span class="lesson-status not-started">‚óã Not Started</span>`;
                }

                // Card title (fallback to slot label)
                const lessonName = (lesson && lesson.lessonName) ? lesson.lessonName : `Lesson ${lesson.slot}`;
                
                return `
                    <div class="lesson-card">
                        <div class="lesson-header">
                            <h3>${lessonName}</h3>
                            ${statusHtml}
                        </div>
                        <div class="lesson-analytics">
                            ${analyticsRows}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadCertificates(certificates) {
            const container = document.getElementById('certificatesContainer');
            
            if (certificates.length === 0) {
                container.innerHTML = '<p class="empty-state">No certificates yet. Keep progressing!</p>';
                return;
            }

            container.innerHTML = certificates.map(cert => `
                <div class="certificate-card">
                    <div class="certificate-icon">üéì</div>
                    <h3>${cert.title || cert.name || 'Certificate'}</h3>
                    <p class="certificate-date">Issued: ${cert.date || 'N/A'}</p>
                    <div class="certificate-actions">
                        <button class="btn-certificate" onclick="viewCertificate('${cert.id || ''}')">View</button>
                        <button class="btn-certificate" onclick="downloadCertificate('${cert.id || ''}')">Download</button>
                    </div>
                </div>
            `).join('');
        }


        function viewCertificate(certId) {
            alert(`Viewing certificate ${certId}`);
        }

        function downloadCertificate(certId) {
            alert(`Downloading certificate ${certId}`);
        }

        function goToProfile() {
            window.location.href = 'student-profile.html';
        }

        // Make loadDashboard accessible globally so it can be called from profile page
        window.loadDashboard = loadDashboard;

        function toggleProfileMenu() {
            alert('Profile menu');
        }

        function logout() {
            localStorage.removeItem('studentToken');
            localStorage.removeItem('studentData');
            window.location.href = 'student-login.html';
        }

        // Load dashboard on page load
        loadDashboard();
        
        // Also reload dashboard if there's a refresh parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('refresh')) {
            console.log('Refresh parameter detected, reloading dashboard data');
            setTimeout(() => {
                loadDashboard();
            }, 100);
        }
    </script>
</body>
</html>
