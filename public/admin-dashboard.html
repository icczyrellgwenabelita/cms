<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASAT Admin Portal</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin-portal.css">
</head>
<body class="admin-portal">
    <!-- Header / Navigation -->
    <header class="portal-header">
        <div class="header-content">
            <div class="logo">ASAT Admin</div>
            <div class="header-right">
                <nav class="nav-tabs">
                    <a href="admin-dashboard.html" class="nav-tab active">Dashboard</a>
                </nav>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="portal-container">
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Lessons Management Section -->
            <section class="lessons-section">
                <div class="section-header">
                    <h1 class="section-title">Lessons Management</h1>
                </div>
                <div class="lessons-grid" id="lessonsContainer">
                    <!-- Lesson cards will be inserted here -->
                </div>
            </section>

            <!-- Quizzes Management Section -->
            <section class="quizzes-section">
                <div class="section-header">
                    <h1 class="section-title">Quizzes Management</h1>
                </div>
                
                <!-- Lesson Tabs -->
                <div class="lesson-tabs" id="lessonTabs">
                    <!-- Lesson tabs will be dynamically generated -->
                </div>
                
                <!-- Quizzes Grid for Selected Lesson -->
                <div class="quizzes-grid" id="quizzesContainer">
                    <!-- Quiz cards will be inserted here for the selected lesson -->
                </div>
            </section>
        </main>
    </div>

    <!-- Lesson Edit Modal -->
    <div id="lessonModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="lessonModalTitle">Edit Lesson</h2>
                <button class="modal-close" onclick="closeLessonModal()">&times;</button>
            </div>
            <form id="lessonForm" onsubmit="saveLesson(event)">
                <input type="hidden" id="lessonSlot" value="">
                <div class="form-group">
                    <label for="lessonName">Lesson Name *</label>
                    <input type="text" id="lessonName" required>
                </div>
                <div class="form-group">
                    <label for="lessonDescription">Lesson Description</label>
                    <textarea id="lessonDescription" rows="4"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeLessonModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Lesson</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quiz Edit Modal -->
    <div id="quizModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="quizModalTitle">Edit Quiz</h2>
                <button class="modal-close" onclick="closeQuizModal()">&times;</button>
            </div>
            <form id="quizForm" onsubmit="saveQuiz(event)">
                <input type="hidden" id="quizLesson" value="">
                <input type="hidden" id="quizSlot" value="">
                <div class="form-group">
                    <label for="quizLessonDisplay">Lesson</label>
                    <input type="text" id="quizLessonDisplay" readonly disabled>
                </div>
                <div class="form-group">
                    <label for="quizQuestion">Question *</label>
                    <textarea id="quizQuestion" rows="3" maxlength="90" required></textarea>
                    <div class="char-counter">
                        <span id="questionCharCount">0</span>/90
                    </div>
                </div>
                <div class="form-group">
                    <label for="quizAnswerA">Answer A *</label>
                    <input type="text" id="quizAnswerA" maxlength="30" required>
                    <div class="char-counter">
                        <span id="answerACharCount">0</span>/30
                    </div>
                </div>
                <div class="form-group">
                    <label for="quizAnswerB">Answer B *</label>
                    <input type="text" id="quizAnswerB" maxlength="30" required>
                    <div class="char-counter">
                        <span id="answerBCharCount">0</span>/30
                    </div>
                </div>
                <div class="form-group">
                    <label for="quizAnswerC">Answer C *</label>
                    <input type="text" id="quizAnswerC" maxlength="30" required>
                    <div class="char-counter">
                        <span id="answerCCharCount">0</span>/30
                    </div>
                </div>
                <div class="form-group">
                    <label for="quizAnswerD">Answer D *</label>
                    <input type="text" id="quizAnswerD" maxlength="30" required>
                    <div class="char-counter">
                        <span id="answerDCharCount">0</span>/30
                    </div>
                </div>
                <div class="form-group">
                    <label for="quizCorrectAnswer">Correct Answer *</label>
                    <select id="quizCorrectAnswer" required>
                        <option value="">Select correct answer</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quizExplanation">Explanation</label>
                    <textarea id="quizExplanation" rows="3" maxlength="80" placeholder="Enter explanation (max 80 characters)"></textarea>
                    <div class="char-counter">
                        <span id="explanationCharCount">0</span>/80
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeQuizModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Quiz</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('adminToken');
        
        if (!token) {
            window.location.href = 'admin-login.html';
        }

        // Load lessons and quizzes
        async function loadLessons() {
            try {
                const response = await fetch('/api/admin/lessons', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const container = document.getElementById('lessonsContainer');
                    container.innerHTML = data.lessons.map(lesson => `
                        <div class="lesson-card">
                            <div class="lesson-card-header">
                                <span class="lesson-number">Lesson ${lesson.slot}</span>
                                <button class="btn-edit" onclick="editLesson(${lesson.slot})">Edit</button>
                            </div>
                            <h3 class="lesson-name">${lesson.lessonName || ''}</h3>
                            <p class="lesson-description">${lesson.lessonDescription || ''}</p>
                        </div>
                    `).join('');
                } else {
                    if (response.status === 401) {
                        logout();
                    }
                }
            } catch (error) {
                console.error('Error loading lessons:', error);
            }
        }

        let currentLesson = 1; // Track currently selected lesson
        let lessonsData = []; // Store lesson names

        // Helper function to get lesson name with format "Lesson X: Lesson Name"
        function getLessonDisplayName(lessonSlot) {
            const lessonNames = {
                1: 'Monitoring Vital Signs',
                2: 'Medication Assistance',
                3: 'Meal Preparation and Feeding',
                4: 'Safe Patient Transfer',
                5: 'Bathing and Grooming the Elderly',
                6: 'Emergency Response (CPR Basics)'
            };
            return `Lesson ${lessonSlot}: ${lessonNames[lessonSlot] || `Lesson ${lessonSlot}`}`;
        }

        // Load lessons first to get names for tabs
        async function loadLessonsForTabs() {
            try {
                const response = await fetch('/api/admin/lessons', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    lessonsData = data.lessons;
                    renderLessonTabs();
                }
            } catch (error) {
                console.error('Error loading lessons for tabs:', error);
            }
        }

        // Render lesson tabs
        function renderLessonTabs() {
            const tabsContainer = document.getElementById('lessonTabs');
            tabsContainer.innerHTML = lessonsData.map(lesson => {
                const lessonName = lesson.lessonName || `Lesson ${lesson.slot}`;
                const isActive = lesson.slot === currentLesson ? 'active' : '';
                return `
                    <button class="lesson-tab ${isActive}" onclick="selectLesson(${lesson.slot})">
                        ${lessonName}
                    </button>
                `;
            }).join('');
        }

        // Select a lesson tab
        function selectLesson(lessonSlot) {
            currentLesson = lessonSlot;
            renderLessonTabs();
            loadQuizzes(lessonSlot);
        }

        async function loadQuizzes(lessonSlot = currentLesson) {
            try {
                console.log(`Loading quizzes for lesson ${lessonSlot}`);
                const response = await fetch(`/api/admin/quizzes/${lessonSlot}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log(`Response status: ${response.status}`);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    const container = document.getElementById('quizzesContainer');
                    const lessonName = getLessonDisplayName(lessonSlot);
                    
                    if (!data.quizzes || data.quizzes.length === 0) {
                        container.innerHTML = `
                            <div class="quizzes-section-header">
                                <h2>${lessonName}</h2>
                            </div>
                            <div class="quizzes-grid-inner">
                                ${Array.from({ length: 10 }, (_, i) => `
                                    <div class="quiz-card">
                                        <div class="quiz-card-header">
                                            <span class="quiz-number">Question ${i + 1}</span>
                                            <button class="btn-edit" onclick="editQuiz(${lessonSlot}, ${i + 1})">Edit</button>
                                        </div>
                                        <h3 class="quiz-question">(No question set)</h3>
                                        <div class="quiz-answers">
                                            <div class="answer-item">
                                                <span class="answer-label">A:</span>
                                                <span>(Not set)</span>
                                            </div>
                                            <div class="answer-item">
                                                <span class="answer-label">B:</span>
                                                <span>(Not set)</span>
                                            </div>
                                            <div class="answer-item">
                                                <span class="answer-label">C:</span>
                                                <span>(Not set)</span>
                                            </div>
                                            <div class="answer-item">
                                                <span class="answer-label">D:</span>
                                                <span>(Not set)</span>
                                            </div>
                                        </div>
                                        <div class="explanation-section">
                                            <label class="explanation-label">Explanation:</label>
                                            <div class="explanation-text"><span class="explanation-empty">No explanation set. Click Edit to add one.</span></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="quizzes-section-header">
                                <h2>${lessonName}</h2>
                            </div>
                            <div class="quizzes-grid-inner">
                                ${data.quizzes.map(quiz => `
                                    <div class="quiz-card">
                                        <div class="quiz-card-header">
                                            <span class="quiz-number">Question ${quiz.slot}</span>
                                            <button class="btn-edit" onclick="editQuiz(${lessonSlot}, ${quiz.slot})">Edit</button>
                                        </div>
                                        <h3 class="quiz-question">${quiz.question || '(No question set)'}</h3>
                                        <div class="quiz-answers">
                                            <div class="answer-item ${quiz.correctAnswer === 'A' ? 'correct' : ''}">
                                                <span class="answer-label">A:</span>
                                                <span>${quiz.answerA || '(Not set)'}</span>
                                            </div>
                                            <div class="answer-item ${quiz.correctAnswer === 'B' ? 'correct' : ''}">
                                                <span class="answer-label">B:</span>
                                                <span>${quiz.answerB || '(Not set)'}</span>
                                            </div>
                                            <div class="answer-item ${quiz.correctAnswer === 'C' ? 'correct' : ''}">
                                                <span class="answer-label">C:</span>
                                                <span>${quiz.answerC || '(Not set)'}</span>
                                            </div>
                                            <div class="answer-item ${quiz.correctAnswer === 'D' ? 'correct' : ''}">
                                                <span class="answer-label">D:</span>
                                                <span>${quiz.answerD || '(Not set)'}</span>
                                            </div>
                                        </div>
                                        ${quiz.correctAnswer ? `<div class="correct-answer-badge">Correct Answer: ${quiz.correctAnswer}</div>` : ''}
                                        <div class="explanation-section">
                                            <label class="explanation-label">Explanation:</label>
                                            <div class="explanation-text">${quiz.explanation || '<span class="explanation-empty">No explanation set. Click Edit to add one.</span>'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                } else {
                    if (response.status === 401) {
                        logout();
                    } else {
                        console.error('Failed to load quizzes:', data);
                        const container = document.getElementById('quizzesContainer');
                        const lessonName = getLessonDisplayName(lessonSlot);
                        container.innerHTML = `
                            <div class="quizzes-section-header">
                                <h2>${lessonName}</h2>
                                <p class="quizzes-count" style="color: #EF4444;">Error loading quizzes: ${data.error || 'Unknown error'}</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading quizzes:', error);
                const container = document.getElementById('quizzesContainer');
                const lessonName = getLessonDisplayName(lessonSlot);
                container.innerHTML = `
                    <div class="quizzes-section-header">
                        <h2>${lessonName}</h2>
                        <p class="quizzes-count" style="color: #EF4444;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function editLesson(slot) {
            fetch(`/api/admin/lessons`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const lesson = data.lessons.find(l => l.slot === slot);
                    document.getElementById('lessonSlot').value = slot;
                    document.getElementById('lessonName').value = lesson.lessonName || '';
                    document.getElementById('lessonDescription').value = lesson.lessonDescription || '';
                    document.getElementById('lessonModalTitle').textContent = `Edit Lesson ${slot}`;
                    document.getElementById('lessonModal').style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('Error loading lesson:', error);
                alert('Failed to load lesson data');
            });
        }

        function closeLessonModal() {
            document.getElementById('lessonModal').style.display = 'none';
            document.getElementById('lessonForm').reset();
        }

        async function saveLesson(e) {
            e.preventDefault();
            const slot = parseInt(document.getElementById('lessonSlot').value);
            const lessonName = document.getElementById('lessonName').value;
            const lessonDescription = document.getElementById('lessonDescription').value;

            try {
                const response = await fetch(`/api/admin/lessons/${slot}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lessonName,
                        lessonDescription
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Lesson saved successfully!');
                    closeLessonModal();
                    loadLessons();
                } else {
                    alert(data.error || 'Failed to save lesson');
                }
            } catch (error) {
                console.error('Error saving lesson:', error);
                alert('Failed to save lesson');
            }
        }

        function editQuiz(lesson, slot) {
            fetch(`/api/admin/quizzes/${lesson}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const quiz = data.quizzes.find(q => q.slot === slot);
                    const lessonName = getLessonDisplayName(lesson);
                    
                    document.getElementById('quizLesson').value = lesson;
                    document.getElementById('quizSlot').value = slot;
                    document.getElementById('quizLessonDisplay').value = lessonName;
                    document.getElementById('quizQuestion').value = quiz.question || '';
                    document.getElementById('quizAnswerA').value = quiz.answerA || '';
                    document.getElementById('quizAnswerB').value = quiz.answerB || '';
                    document.getElementById('quizAnswerC').value = quiz.answerC || '';
                    document.getElementById('quizAnswerD').value = quiz.answerD || '';
                    document.getElementById('quizCorrectAnswer').value = quiz.correctAnswer || '';
                    document.getElementById('quizExplanation').value = quiz.explanation || '';
                    document.getElementById('quizModalTitle').textContent = `Edit Question ${slot} - ${lessonName}`;
                    document.getElementById('quizModal').style.display = 'flex';
                    
                    // Update character counters and setup event listeners
                    setTimeout(() => {
                        updateCharCount('quizQuestion', 'questionCharCount', 90);
                        updateCharCount('quizAnswerA', 'answerACharCount', 30);
                        updateCharCount('quizAnswerB', 'answerBCharCount', 30);
                        updateCharCount('quizAnswerC', 'answerCCharCount', 30);
                        updateCharCount('quizAnswerD', 'answerDCharCount', 30);
                        updateCharCount('quizExplanation', 'explanationCharCount', 80);
                        setupCharCounters();
                    }, 100);
                }
            })
            .catch(error => {
                console.error('Error loading quiz:', error);
                alert('Failed to load quiz data');
            });
        }
        
        // Function to update character counter
        function updateCharCount(inputId, counterId, maxLength) {
            const input = document.getElementById(inputId);
            const counter = document.getElementById(counterId);
            if (input && counter) {
                const currentLength = input.value.length;
                counter.textContent = currentLength;
                if (currentLength >= maxLength) {
                    counter.parentElement.classList.add('char-limit-reached');
                } else {
                    counter.parentElement.classList.remove('char-limit-reached');
                }
            }
        }
        
        // Initialize character counter event listeners
        function setupCharCounters() {
            const questionInput = document.getElementById('quizQuestion');
            const answerAInput = document.getElementById('quizAnswerA');
            const answerBInput = document.getElementById('quizAnswerB');
            const answerCInput = document.getElementById('quizAnswerC');
            const answerDInput = document.getElementById('quizAnswerD');
            
            if (questionInput) {
                questionInput.addEventListener('input', function() {
                    updateCharCount('quizQuestion', 'questionCharCount', 90);
                });
            }
            if (answerAInput) {
                answerAInput.addEventListener('input', function() {
                    updateCharCount('quizAnswerA', 'answerACharCount', 30);
                });
            }
            if (answerBInput) {
                answerBInput.addEventListener('input', function() {
                    updateCharCount('quizAnswerB', 'answerBCharCount', 30);
                });
            }
            if (answerCInput) {
                answerCInput.addEventListener('input', function() {
                    updateCharCount('quizAnswerC', 'answerCCharCount', 30);
                });
            }
            if (answerDInput) {
                answerDInput.addEventListener('input', function() {
                    updateCharCount('quizAnswerD', 'answerDCharCount', 30);
                });
            }
            
            const explanationInput = document.getElementById('quizExplanation');
            if (explanationInput) {
                explanationInput.addEventListener('input', function() {
                    updateCharCount('quizExplanation', 'explanationCharCount', 80);
                });
            }
        }
        
        // Function to update explanation character count in quiz cards
        function updateExplanationCharCount(input, counterId) {
            const counter = document.getElementById(counterId);
            if (counter) {
                const currentLength = input.value.length;
                counter.textContent = currentLength;
                if (currentLength >= 80) {
                    counter.parentElement.classList.add('char-limit-reached');
                } else {
                    counter.parentElement.classList.remove('char-limit-reached');
                }
            }
        }
        
        // Function to save explanation inline
        async function saveExplanation(lesson, slot, explanation) {
            try {
                // Get current quiz data
                const response = await fetch(`/api/admin/quizzes/${lesson}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    const quiz = data.quizzes.find(q => q.slot === slot);
                    
                    // Update quiz with new explanation
                    const updateResponse = await fetch(`/api/admin/quizzes/${lesson}/${slot}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question: quiz.question || '',
                            answerA: quiz.answerA || '',
                            answerB: quiz.answerB || '',
                            answerC: quiz.answerC || '',
                            answerD: quiz.answerD || '',
                            correctAnswer: quiz.correctAnswer || '',
                            explanation: explanation
                        })
                    });
                    
                    const updateData = await updateResponse.json();
                    if (updateResponse.ok && updateData.success) {
                        console.log('Explanation saved successfully');
                    }
                }
            } catch (error) {
                console.error('Error saving explanation:', error);
            }
        }
        
        // Setup counters when page loads (if elements exist)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(setupCharCounters, 100);
            });
        } else {
            setTimeout(setupCharCounters, 100);
        }

        function closeQuizModal() {
            document.getElementById('quizModal').style.display = 'none';
            document.getElementById('quizForm').reset();
            // Reset character counters
            updateCharCount('quizQuestion', 'questionCharCount', 90);
            updateCharCount('quizAnswerA', 'answerACharCount', 30);
            updateCharCount('quizAnswerB', 'answerBCharCount', 30);
            updateCharCount('quizAnswerC', 'answerCCharCount', 30);
            updateCharCount('quizAnswerD', 'answerDCharCount', 30);
            updateCharCount('quizExplanation', 'explanationCharCount', 80);
        }

        async function saveQuiz(e) {
            e.preventDefault();
            const lesson = parseInt(document.getElementById('quizLesson').value);
            const slot = parseInt(document.getElementById('quizSlot').value);
            const question = document.getElementById('quizQuestion').value;
            const answerA = document.getElementById('quizAnswerA').value;
            const answerB = document.getElementById('quizAnswerB').value;
            const answerC = document.getElementById('quizAnswerC').value;
            const answerD = document.getElementById('quizAnswerD').value;
            const correctAnswer = document.getElementById('quizCorrectAnswer').value;
            const explanation = document.getElementById('quizExplanation').value;

            try {
                const response = await fetch(`/api/admin/quizzes/${lesson}/${slot}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question,
                        answerA,
                        answerB,
                        answerC,
                        answerD,
                        correctAnswer,
                        explanation
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Quiz saved successfully!');
                    closeQuizModal();
                    loadQuizzes(lesson);
                } else {
                    alert(data.error || 'Failed to save quiz');
                }
            } catch (error) {
                console.error('Error saving quiz:', error);
                alert('Failed to save quiz');
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminData');
            window.location.href = 'admin-login.html';
        }

        // Close modals on outside click
        window.onclick = function(event) {
            const lessonModal = document.getElementById('lessonModal');
            const quizModal = document.getElementById('quizModal');
            if (event.target === lessonModal) {
                closeLessonModal();
            }
            if (event.target === quizModal) {
                closeQuizModal();
            }
        }

        // Load data on page load
        loadLessons();
        loadLessonsForTabs().then(() => {
            loadQuizzes(currentLesson);
        });
    </script>
</body>
</html>